<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christel Lacaze Swift">
<meta name="dcterms.date" content="2025-07-18">
<meta name="keywords" content="cross-media measurement, multivariate simulation, copulas, tetrachoric correlation">
<meta name="description" content="A practical guide to estimating cross-media audience usage with copulas as an alternative to traditional data fusion approaches.">

<title>Estimating Cross Media Usage Using Copulas – my blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ed588386126076e58696f311bc78420a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-b743186788973eea298c565661da747b.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">my blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Christel Lacaze Swift</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ChristelSwift"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/christellacazeswift/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Estimating Cross Media Usage Using Copulas</h1>
            <p class="subtitle lead">A Practical Guide</p>
                  <div>
        <div class="description">
          <p>A practical guide to estimating cross-media audience usage with copulas as an alternative to traditional data fusion approaches.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">media measurement</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">copulas</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Christel Lacaze Swift <a href="mailto:christel.swift@bbc.co.uk" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              BBC
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 18, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      <p>In media measurement, each medium (TV, radio, online, print…) is traditionally measured by a separate survey or panel that is accepted and governed by both advertising buying and selling sides and described as the “media currency”. In the case of campaigns spanning more than one media, and for media owners with presence across more than one media type, we are often interested in estimating cross-media usage. Data fusion is a widely accepted technique to bring together separate datasets based on common variables. With the increasing use of synthetic datasets, another approach could be based on multivariate modelling such as Copulas.</p>
    </div>
  </div>

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>cross-media measurement, multivariate simulation, copulas, tetrachoric correlation</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> introduction</a></li>
  <li><a href="#a-short-introduction-to-copulas" id="toc-a-short-introduction-to-copulas" class="nav-link" data-scroll-target="#a-short-introduction-to-copulas"><span class="header-section-number">2</span> a short introduction to copulas</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">2.1</span> overview</a></li>
  <li><a href="#some-examples-of-copulas" id="toc-some-examples-of-copulas" class="nav-link" data-scroll-target="#some-examples-of-copulas"><span class="header-section-number">2.2</span> some examples of copulas</a></li>
  <li><a href="#walk-through-with-a-simulated-example" id="toc-walk-through-with-a-simulated-example" class="nav-link" data-scroll-target="#walk-through-with-a-simulated-example"><span class="header-section-number">2.3</span> walk through with a simulated example</a></li>
  <li><a href="#non-continuous-distributions" id="toc-non-continuous-distributions" class="nav-link" data-scroll-target="#non-continuous-distributions"><span class="header-section-number">2.4</span> non-continuous distributions</a></li>
  </ul></li>
  <li><a href="#a-practical-approach-for-non-continuous-margins" id="toc-a-practical-approach-for-non-continuous-margins" class="nav-link" data-scroll-target="#a-practical-approach-for-non-continuous-margins"><span class="header-section-number">3</span> a practical approach for non-continuous margins</a>
  <ul class="collapse">
  <li><a href="#example-using-movielense-dataset" id="toc-example-using-movielense-dataset" class="nav-link" data-scroll-target="#example-using-movielense-dataset"><span class="header-section-number">3.1</span> example using MovieLense dataset</a>
  <ul class="collapse">
  <li><a href="#preparing-the-dataset" id="toc-preparing-the-dataset" class="nav-link" data-scroll-target="#preparing-the-dataset"><span class="header-section-number">3.1.1</span> preparing the dataset</a></li>
  <li><a href="#simulation-using-gaussian-copula" id="toc-simulation-using-gaussian-copula" class="nav-link" data-scroll-target="#simulation-using-gaussian-copula"><span class="header-section-number">3.1.2</span> simulation using Gaussian copula</a></li>
  <li><a href="#univariate-comparison" id="toc-univariate-comparison" class="nav-link" data-scroll-target="#univariate-comparison"><span class="header-section-number">3.1.3</span> univariate comparison</a></li>
  <li><a href="#bivariate-comparison" id="toc-bivariate-comparison" class="nav-link" data-scroll-target="#bivariate-comparison"><span class="header-section-number">3.1.4</span> bivariate comparison</a></li>
  <li><a href="#multivariate-comparison" id="toc-multivariate-comparison" class="nav-link" data-scroll-target="#multivariate-comparison"><span class="header-section-number">3.1.5</span> multivariate comparison</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">3.1.6</span> conclusion</a></li>
  </ul></li>
  <li><a href="#example-using-radio-listening-dataset" id="toc-example-using-radio-listening-dataset" class="nav-link" data-scroll-target="#example-using-radio-listening-dataset"><span class="header-section-number">3.2</span> example using radio listening dataset</a>
  <ul class="collapse">
  <li><a href="#using-spearman-correlation" id="toc-using-spearman-correlation" class="nav-link" data-scroll-target="#using-spearman-correlation"><span class="header-section-number">3.2.1</span> using Spearman correlation</a></li>
  <li><a href="#using-tetrachoric-correlation" id="toc-using-tetrachoric-correlation" class="nav-link" data-scroll-target="#using-tetrachoric-correlation"><span class="header-section-number">3.2.2</span> using Tetrachoric correlation</a></li>
  <li><a href="#conclusion-1" id="toc-conclusion-1" class="nav-link" data-scroll-target="#conclusion-1"><span class="header-section-number">3.2.3</span> conclusion</a></li>
  </ul></li>
  <li><a href="#application-to-measuring-local-cross-media-usage" id="toc-application-to-measuring-local-cross-media-usage" class="nav-link" data-scroll-target="#application-to-measuring-local-cross-media-usage"><span class="header-section-number">3.3</span> application to measuring local cross media usage</a></li>
  </ul></li>
  <li><a href="#conclusion-2" id="toc-conclusion-2" class="nav-link" data-scroll-target="#conclusion-2"><span class="header-section-number">4</span> conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">5</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> introduction</h1>
<p>Bringing separate datasets together is a common issue in media measurement because traditionally each medium is measured by a different system: in the UK, TV is measured by Barb, radio by RAJAR, published media by Pamco, outdoor media by Route etc… These separate media studies are called “currencies” because they are governed by joint industry committees with representatives from both the buying and selling side, and are therefore accepted as the trading system for each medium.</p>
<p>Advertising campaigns on each medium are planned, bought and traded using these separate studies. However there is a need to understand how many people have been reached and how many times across all media for each campaign. For media owners present across more than one media type, they also want to be able to measure their combined audience regardless of media.</p>
<p>This is mainly done using <strong>data fusion</strong> (see Ipsos’s white paper <span class="citation" data-cites="sharot">(<a href="#ref-sharot" role="doc-biblioref">Sharot 2011</a>)</span>) where the best statistical matches are found across studies and brought together to form one fully granular dataset. A prominent example of this is the IPA’s Touchpoints study. To find good matches between respondents from the different datasets, a good set of explanatory common variables is crucial. Data fusion relies on the assumption of conditional independence, meaning that for example we assume that tv viewing behaviour can be fully explain by these common hooks. In practice this is rarely the case and the remaining unexplained variance leads to what is commonly called “regression to the mean”: the interaction between two fused variables is never as strong as it would be if they were coming from the same study, and it ends up somewhere between the truth and what it would be in the case of independence (i.e.&nbsp;one variable has no association with the other). However this is seen as an acceptable trade-off as the fused datasets allow full flexibility in data analysis.</p>
<p>In this article, we explore another way to bring separate univariate distributions together using <strong>copulas</strong>, a very flexible statistical technique for multivariate modelling. With the help of reproducible examples, we demonstrate the process of recreating a simulated dataset from the observed correlation and marginal distributions of a real dataset. The use of the <strong>Tetrachoric correlation</strong> is particularly well-suited for the case of zero-inflated distributions when the main objective is to preserve the combined reach.</p>
</section>
<section id="a-short-introduction-to-copulas" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> a short introduction to copulas</h1>
<section id="overview" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">2.1</span> overview</h2>
<p>Copulas are used to model the dependence structure of multivariate distributions. They were introduced by Abe Sklar <span class="citation" data-cites="sklar">(<a href="#ref-sklar" role="doc-biblioref">Sklar 1959</a>)</span> in 1959 and are particularly popular in quantitative finance for risk management and portfolio optimisation.</p>
<p>A copula takes as input random variables <span class="math inline">\(U_i\)</span> that are uniformly distributed on <span class="math inline">\([0,1]\)</span> and it will then output their joint cumulative distribution: given the uniforms <span class="math inline">\(U_1, ...,U_k\)</span> a copula <span class="math inline">\(C\)</span> would output <span class="math inline">\(C(u_1,... u_k) = P(U_1 \leq u_1, ...,U_k \leq u_k)\)</span>.</p>
<p>The property called the <strong>Probability Integral Transform</strong>, also known as the <strong>Universality of the Uniform</strong>, states that any continuous distribution can be converted to a standard uniform distribution and vice-versa: if <span class="math inline">\(X\)</span> is a continuous variable with cumulative distribution <span class="math inline">\(F_X\)</span>, then the random variable <span class="math inline">\(Y := F_X(X)\)</span> has a standard uniform distribution.</p>
<p>Using this property we can then map the uniform margins from our copula to any continuous distribution using their quantile function.</p>
<p>Working with copulas means that we can separate the problems of modelling the margins and modelling the dependence structure. These tow steps can be done independently.</p>
<p>In practice, a possible multivariate modelling workflow could be as follows:<br>
- given a multivariate distribution, take their margins and find the best univariate model for each one.<br>
- transform each margin by taking their pseudo-observations, i.e.&nbsp;their ranks: this will make each margin uniformly distributed on <span class="math inline">\([0,1]\)</span>.<br>
- find a good copula that fits the resulting dependence structure.</p>
<p>Then to produce a random sample from this modelled distribution:<br>
- create a random sample from the chosen copula: each margin will be <span class="math inline">\(U[0,1]\)</span> but they will be linked by the chosen dependence structure.<br>
- transform each margin to the chosen univariate distributions: the dependence structure will be preserved.</p>
</section>
<section id="some-examples-of-copulas" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="some-examples-of-copulas"><span class="header-section-number">2.2</span> some examples of copulas</h2>
<p>The main families of copulas are the <strong>elliptical</strong> (e.g.&nbsp;Gaussian and Student-t) and <strong>Archimedean</strong> copulas (e.g.&nbsp;Clayton, Frank, Gumbel, Joe).</p>
<p>Different copulas allow for different dependence shapes, including asymmetrical, and different emphasis on the tails.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="copula_2d_examples.png" class="img-fluid figure-img"></p>
<figcaption>examples of copulas</figcaption>
</figure>
</div>
<p>The Archimedean copulas only take one parameter which means they can only be used when we assume the same dependence between all pairs of variables.</p>
<p>The Gaussian copula is based on a correlation matrix where each pair of variables can have their own value. The same applies to the Student-t with an added parameter <span class="math inline">\(\nu\)</span> for the degrees of freedom which controls the tail dependence: lower values correspond to heavier tails, so that extreme joint events are more likely. The Student-t copula approaches the Gaussian as <span class="math inline">\(\nu\)</span> increases.</p>
</section>
<section id="walk-through-with-a-simulated-example" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="walk-through-with-a-simulated-example"><span class="header-section-number">2.3</span> walk through with a simulated example</h2>
<p>Here we show how to go from a multivariate normal distribution with a given correlation matrix to a multivariate distribution with the same correlation but with different margins: a Gamma, a Beta and a Student-t.</p>
<p>The multivariate normal distribution (MVN) is essentially a Gaussian copula with Gaussian margins. It is easy to generate a random sample from a MVN from most statistical tools, and it can even be done in excel. In R, we can use <code>MASS::mvrnorm</code>. More complex copulas can be found in the dedicated <code>copula</code> package (see <span class="citation" data-cites="copula_package">(<a href="#ref-copula_package" role="doc-biblioref">Yan 2007</a>)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS) <span class="co"># to use the multivariate normal distribution mvrnorm</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure to load tidyverse after MASS so that the select function comes from dplyr</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(psych) <span class="co"># for the pairs.panels and phi2tetra functions</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span>) <span class="co"># to suppress annoying grouping warning</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>()) <span class="co"># sets the ggplot theme for the session</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># specify a correlation matrix:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>my_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.4</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.8</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.2</span>, <span class="sc">-</span><span class="fl">0.8</span>, <span class="dv">1</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">3</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># produce a random sample of 10k units </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># on 3 normal margins N(0,1) with the specified correlation:</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>my_sim <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> n,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sigma =</span> my_cor</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(my_sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       V1                  V2                  V3            
 Min.   :-3.886273   Min.   :-4.134011   Min.   :-3.8664468  
 1st Qu.:-0.688413   1st Qu.:-0.678848   1st Qu.:-0.6775139  
 Median :-0.008261   Median :-0.011869   Median : 0.0103952  
 Mean   :-0.012727   Mean   :-0.006768   Mean   :-0.0003453  
 3rd Qu.: 0.663353   3rd Qu.: 0.687833   3rd Qu.: 0.6599113  
 Max.   : 4.195759   Max.   : 3.307045   Max.   : 3.8395707  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(my_sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2]       [,3]
[1,] 1.0000000  0.4021567  0.1970059
[2,] 0.4021567  1.0000000 -0.8000375
[3,] 0.1970059 -0.8000375  1.0000000</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs.panels</span>(my_sim, <span class="at">cex.cor=</span><span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The first step is to take their pseudo-observations, or ranks, to turn each margin into a standard uniform <span class="math inline">\(U(0,1)\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>my_sim_pseudo_obs <span class="ot">&lt;-</span> my_sim <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the original row numbering so we can use it later:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rownum =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(V1<span class="sc">:</span>V3, <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(variable) <span class="sc">%&gt;%</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># divide the rank by n+1 to ensure the result is &lt; 1:</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pseudo_obs =</span> <span class="fu">rank</span>(value)<span class="sc">/</span> (n<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>value) <span class="sc">%&gt;%</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> variable, <span class="at">values_from =</span> pseudo_obs)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(my_sim_pseudo_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  rownum    V1    V2    V3
   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1      1 0.154 0.190 0.491
2      2 0.640 0.433 0.493
3      3 0.120 0.171 0.570
4      4 0.853 0.124 0.951
5      5 0.618 0.424 0.743
6      6 0.823 0.596 0.571</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(my_sim_pseudo_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     rownum            V1                   V2                   V3            
 Min.   :    1   Min.   :0.00009999   Min.   :0.00009999   Min.   :0.00009999  
 1st Qu.: 2501   1st Qu.:0.25005000   1st Qu.:0.25005000   1st Qu.:0.25005000  
 Median : 5000   Median :0.50000000   Median :0.50000000   Median :0.50000000  
 Mean   : 5000   Mean   :0.50000000   Mean   :0.50000000   Mean   :0.50000000  
 3rd Qu.: 7500   3rd Qu.:0.74995000   3rd Qu.:0.74995000   3rd Qu.:0.74995000  
 Max.   :10000   Max.   :0.99990001   Max.   :0.99990001   Max.   :0.99990001  </code></pre>
</div>
</div>
<p>The pseudo-observations are all standard uniforms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>my_sim_pseudo_obs <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>rownum) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pairs.panels</span>(<span class="at">cex.cor=</span><span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>By using the pseudo-observations of each margin, they have become <span class="math inline">\(U(0,1)\)</span> but the correlation is still the same. The empirical cumulative distribution of this multivariate sample is our empirical copula: it has a Gaussian dependence structure with standard uniform margins.</p>
<p>Note that in this case, as we know that our margins were originally <span class="math inline">\(N(0,1)\)</span>, we could have used their distribution function <code>pnorm</code> to turn them into uniforms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>my_sim_p <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(my_sim)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs.panels</span>(my_sim_p, <span class="at">method =</span> <span class="st">"spearman"</span>, <span class="at">cex.cor=</span><span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>By taking the pseudo-observations of the margins, we’re left with just the dependence structure.</p>
<p>Now that we have uniform margins we can transform them into any continuous distribution, for example a Gamma, a Beta and a Student t using their quantile functions <code>qgamma</code>, <code>qbeta</code> and <code>qt</code> (i.e.&nbsp;inverse CDFs):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>my_sim_new <span class="ot">&lt;-</span> my_sim_pseudo_obs <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(V1<span class="sc">:</span>V3, <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"x"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"V1"</span> <span class="sc">~</span> <span class="fu">qgamma</span>(x, <span class="at">shape =</span> <span class="dv">2</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"V2"</span> <span class="sc">~</span> <span class="fu">qbeta</span>(x, <span class="at">shape1 =</span> <span class="dv">3</span>, <span class="at">shape2 =</span> <span class="dv">2</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"V3"</span> <span class="sc">~</span> <span class="fu">qt</span>(x, <span class="at">df =</span> <span class="dv">5</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> variable, <span class="at">values_from =</span> y)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>my_sim_new <span class="sc">%&gt;%</span> </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>rownum) <span class="sc">%&gt;%</span> </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use the Spearman correlation as it is based on ranks:</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pairs.panels</span>(<span class="at">method =</span> <span class="st">"spearman"</span>, <span class="at">cex.cor=</span><span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>We started with a multivariate normal and we now have a multivariate distribution made of a Gamma, a Beta and a Student t margins but the transformation preserved the dependence structure.</p>
<p>Note that when working with copulas, and in particular when comparing correlations, we use a rank-based correlation like <strong>Spearman’s rho</strong> or <strong>Kendall’s tau</strong> rather than the Pearson correlation. As the Spearman and Kendall coefficients are based on the ranks rather than the actual values, they will not be distorted by skewed or asymmetrical margins.</p>
</section>
<section id="non-continuous-distributions" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="non-continuous-distributions"><span class="header-section-number">2.4</span> non-continuous distributions</h2>
<p>The Sklar theorem states that for any multivariate distribution with continuous margins, there exists a unique copula <span class="math inline">\(C\)</span> such that:</p>
<p><span class="math display">\[F(x_1, x_2, \dots, x_d) = C(F_1(x_1), F_2(x_2), \dots, F_d(x_d))\]</span> where:<br>
- <span class="math inline">\(F\)</span> is the joint CDF,<br>
- <span class="math inline">\(F_i\)</span> are the marginal CDFs,<br>
- <span class="math inline">\(C\)</span> is the copula.</p>
<p>However when the margins are non-continuous, this theorem no longer holds and the uniqueness is not guaranteed, see <span class="citation" data-cites="genest">(<a href="#ref-genest" role="doc-biblioref">Nešlehová 2007</a>)</span>.</p>
<p>From a practical point, when margins are not continuous, they can no longer be mapped to uniform margins. For example, in the case of a zero-inflated distribution, we would also end up with a spike at zero when taking the pseudo-observations: many observations would have the same rank. In turn, this would mean we would no longer be able to uniquely transform the pseudo-values using the inverse CDF.</p>
</section>
</section>
<section id="a-practical-approach-for-non-continuous-margins" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> a practical approach for non-continuous margins</h1>
<p>One possible approach to cope with non-continuous margins is to assume they stem from latent continuous variables. We can still generate a random sample from a multivariate copula but then we can map their margins to the desired quantiles, either of a known distribution like the Poisson, or an empirical cumulative distribution. This approach has been explored in the case of Poisson margins in <span class="citation" data-cites="poisson_multivariate">Shmueli (<a href="#ref-poisson_multivariate" role="doc-biblioref">2008</a>)</span>. Using any copula, we could still generate a random sample using the observed rank-based correlation (e.g.&nbsp;Spearman), and map each segment of the resulting <span class="math inline">\(U(0,1)\)</span> to specified discrete values.</p>
<p>Let:<br>
- <span class="math inline">\(Z \sim N(0,1)\)</span> be a standard normal random variable.<br>
- <span class="math inline">\(F(z)\)</span> be the CDF of the standard normal distribution. (note that by virtue of the Probability Integral Transform, <span class="math inline">\(F(z) \sim U(0,1)\)</span>).<br>
- <span class="math inline">\(G^{−1}(p)\)</span> be the quantile function (inverse CDF) of the target discrete distribution (e.g., Poisson).<br>
- <span class="math inline">\(Y\)</span> be the mapped discrete random variable.</p>
<p>Then the mapping is: <span class="math display">\[Y = G^{-1}(F(z)) = \text{inf}\{x \in \mathbb{Z}_{\geq 0}: G(x) \geq F(z)\}\]</span></p>
<p>Taking the example of a discrete random variable <span class="math inline">\(X\)</span> with cumulative distribution defined by:<br>
<span class="math inline">\(P(X \leq 0) = 0.25\)</span>.<br>
<span class="math inline">\(P(X \leq 1) = 0.75\)</span>.<br>
<span class="math inline">\(P(X \leq 2) = 1\)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To transform the variable <span class="math inline">\(Z \sim N(0,1)\)</span> on the left into this discrete cumulative distribution on the right we would use the following mapping:</p>
<ul>
<li>any value of <span class="math inline">\(F(z)\)</span> between 0 and 0.25 becomes 0.</li>
<li>any value of <span class="math inline">\(F(z)\)</span> between 0.25 and 0.75 becomes 1.</li>
<li>any value of <span class="math inline">\(F(z)\)</span> between 0.25 and 1 becomes 2.</li>
</ul>
<p>In the following sections we will see how we can reproduce a dataset with discrete margins using a Gaussian copula and the empirical cumulative distribution of each margin, using two examples to illustrate different multivariate non-continuous scenarios. The first example looks at the distribution of the number of films by genre by viewer, the second example is based on time spent listening to different radio stations by person.</p>
<p>In the second example we will see what happens when dealing with <strong>zero-inflated</strong> or <strong>hurdle</strong> distributions. In these cases, the mass at zero creates a distortion and the rank-based correlation is not optimal to recover the desired joint zero case. In media research we are often interested in the combined reach of two or more media, for example the probability of watching channel 1 or channel 2 <span class="math inline">\(P(X_1 &gt; 0 | X_2 &gt; 0)\)</span>, which is the same as 1 minus the probability of not watching either <span class="math inline">\(1 - P(X_1 = 0, X_2 = 0)\)</span> so estimating the joint zero case is of particular importance.</p>
<p>A hurdle distribution can be thought of a two part process where the first part is binary (e.g.&nbsp;users / non users) and the second part is continuous or discrete (e.g.&nbsp;number of items purchased, number of hours listened… ). Then it turns out that using the <strong>Tetrachoric correlation</strong> (see <span class="citation" data-cites="tetrachoric">(<a href="#ref-tetrachoric" role="doc-biblioref"><span>“Estimating Correlation from Dichotomized Normal Variables”</span> 2009</a>)</span>) is a much better choice for the simulation if the objective is to preserve the combined reach. In a similar vein, <span class="citation" data-cites="greenens2020">Greenens (<a href="#ref-greenens2020" role="doc-biblioref">2020</a>)</span> suggests using the <strong>Yule coefficient</strong>.</p>
<section id="example-using-movielense-dataset" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="example-using-movielense-dataset"><span class="header-section-number">3.1</span> example using MovieLense dataset</h2>
<p>To provide a reproducible example for the discrete case, we can use the MovieLense dataset that is made available in the R package <code>recommenderlab</code>. It contains about 100,000 ratings from 943 users on 1664 movies. Movie genres are also made available in the MovieLenseMeta dataset so we can derive a multivariate dataset showing the number of items each user has watched from each genre.</p>
<section id="preparing-the-dataset" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="preparing-the-dataset"><span class="header-section-number">3.1.1</span> preparing the dataset</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(recommenderlab) <span class="co"># to use the MovieLense dataset</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor) <span class="co"># to use the clean_names function</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"MovieLense"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(MovieLense)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Formal class 'realRatingMatrix' [package "recommenderlab"] with 2 slots
  ..@ data     :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. ..@ i       : int [1:99392] 0 1 4 5 9 12 14 15 16 17 ...
  .. .. ..@ p       : int [1:1665] 0 452 583 673 882 968 994 1386 1605 1904 ...
  .. .. ..@ Dim     : int [1:2] 943 1664
  .. .. ..@ Dimnames:List of 2
  .. .. .. ..$ : chr [1:943] "1" "2" "3" "4" ...
  .. .. .. ..$ : chr [1:1664] "Toy Story (1995)" "GoldenEye (1995)" "Four Rooms (1995)" "Get Shorty (1995)" ...
  .. .. ..@ x       : num [1:99392] 5 4 4 4 4 3 1 5 4 5 ...
  .. .. ..@ factors : list()
  ..@ normalize: NULL</code></pre>
</div>
</div>
<p>The data is stored as a <code>realRatingMatrix</code> object so we first turn it into a dataframe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>films_rld <span class="ot">&lt;-</span> <span class="fu">summary</span>(MovieLense<span class="sc">@</span>data) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(films_rld) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"user_id"</span>, <span class="st">"film_id"</span>, <span class="st">"rating"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(films_rld)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  user_id film_id rating
1       1       1      5
2       2       1      4
3       5       1      4
4       6       1      4
5      10       1      4
6      13       1      3</code></pre>
</div>
</div>
<p>The <code>MovieLenseMeta</code> dataset shows the genre classification for each film, in the same order as the dimension names in MovieLense:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>MovieLenseMeta <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.character)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">substring</span>(value, <span class="dv">1</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 2
   name       value                                   
   &lt;chr&gt;      &lt;chr&gt;                                   
 1 title      Toy Story (1995)                        
 2 year       1995                                    
 3 url        http://us.imdb.com/M/title-exact?Toy%20S
 4 unknown    0                                       
 5 Action     0                                       
 6 Adventure  0                                       
 7 Animation  1                                       
 8 Children's 1                                       
 9 Comedy     1                                       
10 Crime      0                                       
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>Add the genres to each film (the same film may have more than one genre):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>film_genres <span class="ot">&lt;-</span> MovieLenseMeta <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">film_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year ,<span class="sc">-</span>unknown, <span class="sc">-</span>url) </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(film_genres, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              title action adventure animation childrens comedy crime
1  Toy Story (1995)      0         0         1         1      1     0
2  GoldenEye (1995)      1         1         0         0      0     0
3 Four Rooms (1995)      0         0         0         0      0     0
4 Get Shorty (1995)      1         0         0         0      1     0
5    Copycat (1995)      0         0         0         0      0     1
  documentary drama fantasy film_noir horror musical mystery romance sci_fi
1           0     0       0         0      0       0       0       0      0
2           0     0       0         0      0       0       0       0      0
3           0     0       0         0      0       0       0       0      0
4           0     1       0         0      0       0       0       0      0
5           0     1       0         0      0       0       0       0      0
  thriller war western film_id
1        0   0       0       1
2        1   0       0       2
3        1   0       0       3
4        0   0       0       4
5        1   0       0       5</code></pre>
</div>
</div>
<p>Build the genre dataset by joining the film respondent level dataset with the film genres:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>genres_rld <span class="ot">&lt;-</span> films_rld <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(film_genres, <span class="at">by =</span> <span class="st">"film_id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(action<span class="sc">:</span>western, <span class="at">names_to =</span> <span class="st">"genre"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_id, genre) <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(genres_rld)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  user_id genre         n
    &lt;int&gt; &lt;chr&gt;     &lt;int&gt;
1       1 action       75
2       1 adventure    42
3       1 animation    12
4       1 childrens    25
5       1 comedy       91
6       1 crime        25</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>all_genres <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(genres_rld<span class="sc">$</span>genre))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>genres_rld <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(genre) <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">reach =</span> <span class="fu">n_distinct</span>(user_id),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">sum</span>(n)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> reach, <span class="at">y =</span> genre)) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"slateblue"</span>) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">limits=</span>rev) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Movielens: reach by genre"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then for each genre what is the distribution of number of viewed items?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>genres_rld_wide <span class="ot">&lt;-</span> genres_rld <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pivot wider so we can add the zero values:</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> genre, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">id =</span> user_id)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(genres_rld_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 19
     id action adventure animation childrens comedy crime documentary drama
  &lt;int&gt;  &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;int&gt; &lt;int&gt;       &lt;int&gt; &lt;int&gt;
1     1     75        42        12        25     91    25           5   106
2     2     10         3         1         4     16     9           0    34
3     3     14         4         0         0     12     9           1    19
4     4      8         4         0         0      4     4           1     5
5     5     56        33        14        29     82     9           0    27
6     6     25        21        10        19     66    14           1   102
# ℹ 10 more variables: fantasy &lt;int&gt;, film_noir &lt;int&gt;, horror &lt;int&gt;,
#   musical &lt;int&gt;, mystery &lt;int&gt;, romance &lt;int&gt;, sci_fi &lt;int&gt;, thriller &lt;int&gt;,
#   war &lt;int&gt;, western &lt;int&gt;</code></pre>
</div>
</div>
<p>Keep a record of the distribution of the volume metric for each genre:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>actual_distr <span class="ot">&lt;-</span> genres_rld_wide <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name, value) <span class="sc">%&gt;%</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumpc =</span> <span class="fu">cumsum</span>(pc)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(actual_distr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  name   value     n      pc   cumpc
  &lt;chr&gt;  &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 action     0     5 0.00530 0.00530
2 action     1    11 0.0117  0.0170 
3 action     2    20 0.0212  0.0382 
4 action     3    32 0.0339  0.0721 
5 action     4    30 0.0318  0.104  
6 action     5    44 0.0467  0.151  </code></pre>
</div>
</div>
<p>Plot the distribution of the margins:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>actual_distr <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&lt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pc, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"MovieLense: distribution of number of films watched (truncated at 10)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>This dataset shows a variety of discrete distributions representing the number of films each person watched for each genre. Note that some distributions like Drama and Romance don’t have a zero value. Everyone in this dataset has watched at least one film.</p>
</section>
<section id="simulation-using-gaussian-copula" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="simulation-using-gaussian-copula"><span class="header-section-number">3.1.2</span> simulation using Gaussian copula</h3>
<p>The Gaussian copula is the easiest to implement as it doesn’t require installing any additional package in R. It can be created using <code>MASS::mvrnorm</code>.</p>
<p>To create a simulation of the genres_rld dataset, we first calculate its Spearman correlation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>spearman_cor <span class="ot">&lt;-</span> genres_rld_wide <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(<span class="at">method =</span> <span class="st">"spearman"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>spearman_cor[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             action adventure animation childrens    comedy
action    1.0000000 0.9461663 0.7033189 0.7288907 0.7867559
adventure 0.9461663 1.0000000 0.7735571 0.7928897 0.8215120
animation 0.7033189 0.7735571 1.0000000 0.8716790 0.7602097
childrens 0.7288907 0.7928897 0.8716790 1.0000000 0.8066026
comedy    0.7867559 0.8215120 0.7602097 0.8066026 1.0000000</code></pre>
</div>
</div>
<p>Next, we generate a random sample of 100k units from a multivariate Normal using these observed correlations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100000</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> n, </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(spearman_cor)), </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sigma =</span> spearman_cor</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(simdata[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     action          adventure         animation           childrens      
 Min.   :-1.3817   Min.   :-1.6258   Min.   :-2.351214   Min.   :-2.3494  
 1st Qu.:-0.9830   1st Qu.:-1.1368   1st Qu.:-1.360031   1st Qu.:-0.8189  
 Median :-0.4934   Median :-0.7353   Median :-0.682401   Median :-0.7727  
 Mean   :-0.5722   Mean   :-0.7217   Mean   :-0.751267   Mean   :-0.6851  
 3rd Qu.:-0.3034   3rd Qu.:-0.3517   3rd Qu.:-0.008015   3rd Qu.: 0.2231  
 Max.   : 0.3006   Max.   : 0.2410   Max.   : 0.645323   Max.   : 0.2925  
     comedy            crime          documentary           drama        
 Min.   :-1.3483   Min.   :-1.9235   Min.   :-2.86456   Min.   :-1.8829  
 1st Qu.:-0.9705   1st Qu.:-0.6761   1st Qu.:-0.69672   1st Qu.:-0.9353  
 Median :-0.7107   Median : 0.1265   Median :-0.03413   Median :-0.7946  
 Mean   :-0.5316   Mean   :-0.3785   Mean   :-0.47859   Mean   :-0.7699  
 3rd Qu.:-0.4503   3rd Qu.: 0.2301   3rd Qu.: 0.25707   3rd Qu.:-0.3934  
 Max.   : 0.8218   Max.   : 0.3506   Max.   : 0.94537   Max.   : 0.1568  
    fantasy          film_noir           horror           musical       
 Min.   :-1.1568   Min.   :-1.5314   Min.   :-1.4874   Min.   :-1.8693  
 1st Qu.:-0.8651   1st Qu.:-0.6781   1st Qu.:-0.7694   1st Qu.:-1.0213  
 Median :-0.2646   Median :-0.4907   Median :-0.5717   Median :-1.0016  
 Mean   :-0.1923   Mean   :-0.5074   Mean   :-0.5355   Mean   :-0.7014  
 3rd Qu.: 0.4770   3rd Qu.:-0.1773   3rd Qu.:-0.2256   3rd Qu.:-0.2046  
 Max.   : 0.8482   Max.   : 0.3405   Max.   : 0.3767   Max.   : 0.5898  
    mystery           romance            sci_fi           thriller      
 Min.   :-1.5326   Min.   :-1.6708   Min.   :-0.9721   Min.   :-1.5443  
 1st Qu.:-0.3824   1st Qu.:-1.1107   1st Qu.:-0.7636   1st Qu.:-0.8727  
 Median :-0.1736   Median :-0.6660   Median :-0.4596   Median :-0.5293  
 Mean   :-0.2116   Mean   :-0.7377   Mean   :-0.3985   Mean   :-0.5975  
 3rd Qu.: 0.2609   3rd Qu.:-0.5148   3rd Qu.:-0.3145   3rd Qu.:-0.2432  
 Max.   : 0.7697   Max.   : 0.2736   Max.   : 0.5173   Max.   : 0.2019  
      war              western       
 Min.   :-1.28294   Min.   :-2.0486  
 1st Qu.:-0.99671   1st Qu.:-0.9132  
 Median :-0.48773   Median :-0.8956  
 Mean   :-0.49834   Mean   :-0.7299  
 3rd Qu.: 0.00547   3rd Qu.:-0.4066  
 Max.   : 0.27018   Max.   : 0.6147  </code></pre>
</div>
</div>
<p>We now have a multivariate normal where the margins are <span class="math inline">\(N(0,1)\)</span> and the correlation is the observed Spearman correlation of the original dataset.</p>
<p>Next we map the cumulative distributions of these <span class="math inline">\(N(0,1)\)</span> margins to the observed cumulative distributions.</p>
<p>Let’s walk through the process using the Documentary genre as it has the lowest number of distinct values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">7</span> <span class="co"># index for Documentaries</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>actual_var_distr <span class="ot">&lt;-</span> actual_distr <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">==</span> all_genres[i])</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>actual_var_distr <span class="sc">%&gt;%</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">min</span>(value),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(value)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
      n   min   max
  &lt;int&gt; &lt;int&gt; &lt;int&gt;
1    13     0    20</code></pre>
</div>
</div>
<p>We have 13 distinct possible values for this distribution, ranging from 0 to 20.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>actual_var_distr <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prev_cumpc =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="fu">lag</span>(cumpc)), <span class="dv">0</span>, <span class="fu">lag</span>(cumpc))) <span class="sc">%&gt;%</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">|</span> value <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(value, n,  prev_cumpc, cumpc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  value     n prev_cumpc cumpc
  &lt;int&gt; &lt;int&gt;      &lt;dbl&gt; &lt;dbl&gt;
1     0   591      0     0.627
2     1   183      0.627 0.821
3     2    83      0.821 0.909
4    13     2      0.996 0.998
5    16     1      0.998 0.999
6    20     1      0.999 1    </code></pre>
</div>
</div>
<p>Following the actual cumulative distribution, in our simulated datset we will also want:<br>
- anything under 62.7% to be mapped to 0.<br>
- anything between 62.7% and 82.1% to be mapped to 1.<br>
- etc….<br>
- anything &gt; 99.9% to be mapped to 20.</p>
<p>Take the corresponding margin in our simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> simdata[, i]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-4.342483 -0.668564  0.002788  0.003698  0.676800  4.573686 </code></pre>
</div>
</div>
<p>Plot the cumulative distribution of our actual margin and the result of the MVN simulation before transformation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actual cumulative distribution for genre = "action":</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  actual_var_distr <span class="sc">%&gt;%</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, value, cumpc),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># untransformed simulated cumulative distribution for genre = "action":</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> all_genres[i],</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">round</span>(s, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, value) <span class="sc">%&gt;%</span> </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">cumpc =</span> <span class="fu">cumsum</span>(pc),</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">source =</span> <span class="st">"sim"</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, value, cumpc)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> cumpc, <span class="at">col =</span> source)) <span class="sc">+</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"slateblue1"</span>, <span class="st">"darkorange"</span>)) <span class="sc">+</span> </span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>source, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"cumulative distribution for genre = documentary"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The untransformed simulated margin in orange is the cumulative distribution of a <span class="math inline">\(N(0,1)\)</span> and we want to transform all its values so it looks like the observed margin in blue.</p>
<p>Find the critical values so we can map the simulated values to these probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(s, actual_var_distr<span class="sc">$</span>cumpc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>62.67232% 82.07847% 90.88017% 94.27359% 96.92471% 98.40933% 98.72747%  99.0456% 
0.3258383 0.9196472 1.3338876 1.5817369 1.8715100 2.1545824 2.2452217 2.3575869 
99.46978% 99.57582% 99.78791% 99.89396%      100% 
2.5733421 2.6331406 2.8528658 3.0762966 4.5736860 </code></pre>
</div>
</div>
<p>So in our simulated margin, we will map:<br>
- anything that is <span class="math inline">\(\leq 0.3258\)</span> to zero,<br>
- anything that is <span class="math inline">\(&gt; 0.3258\)</span> and <span class="math inline">\(\leq 0.9196\)</span> to one,<br>
- etc…<br>
- anything that is <span class="math inline">\(&gt; 4.574\)</span> to 20</p>
<p>To define the breaks for the <code>cut</code> function, we also need a lower bound which is the minimum of the simulated margin:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>crv <span class="ot">=</span> <span class="fu">as.vector</span>(<span class="fu">c</span>(<span class="fu">min</span>(s), <span class="fu">quantile</span>(s, actual_var_distr<span class="sc">$</span>cumpc)))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>crv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -4.3424830  0.3258383  0.9196472  1.3338876  1.5817369  1.8715100
 [7]  2.1545824  2.2452217  2.3575869  2.5733421  2.6331406  2.8528658
[13]  3.0762966  4.5736860</code></pre>
</div>
</div>
<p>Show what happens when we apply these breaks to our simulated margin:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">s =</span> s) <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cuts =</span> <span class="fu">cut</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    s, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> crv,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">right =</span> <span class="cn">TRUE</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cuts) <span class="sc">%&gt;%</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">min =</span> <span class="fu">min</span>(s), <span class="at">max =</span> <span class="fu">max</span>(s), <span class="at">n =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 4
   cuts             min   max     n
   &lt;fct&gt;          &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
 1 [-4.34,0.326] -4.34  0.326 62672
 2 (0.326,0.92]   0.326 0.920 19406
 3 (0.92,1.33]    0.920 1.33   8802
 4 (1.33,1.58]    1.33  1.58   3393
 5 (1.58,1.87]    1.58  1.87   2651
 6 (1.87,2.15]    1.87  2.15   1485
 7 (2.15,2.25]    2.15  2.25    318
 8 (2.25,2.36]    2.25  2.36    318
 9 (2.36,2.57]    2.36  2.57    424
10 (2.57,2.63]    2.57  2.63    106
11 (2.63,2.85]    2.63  2.85    212
12 (2.85,3.08]    2.85  3.07    106
13 (3.08,4.57]    3.08  4.38    106
14 &lt;NA&gt;           4.57  4.57      1</code></pre>
</div>
</div>
<p>Note that the last cut isn’t quite right: due to rounding, the maximum value of the distribution ends up in the NA category, when it should be in the last break. This will have to be corrected when we apply the critical values.</p>
<p>Cut the simulated normal data according to the breaks given by the crv table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">cut</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    s,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">right =</span> <span class="cn">TRUE</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> crv,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> actual_var_distr<span class="sc">$</span>value</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    0     1     2     3     4     5     6     7     8    10    13    16    20 
62672 19406  8802  3393  2651  1485   318   318   424   106   212   106   106 
 NA's 
    1 </code></pre>
</div>
</div>
<p>Note that we have named levels (factors) which will have to be converted to numeric. Also, the NA entry should be converted to the maximum value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 0 0 0 0 1
Levels: 0 1 2 3 4 5 6 7 8 10 13 16 20</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>s[<span class="fu">is.na</span>(temp)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.573686</code></pre>
</div>
</div>
<p>Convert the factor levels back to numeric values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>sim_temp <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(temp)))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sim_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     value        
 Min.   : 0.0000  
 1st Qu.: 0.0000  
 Median : 0.0000  
 Mean   : 0.8038  
 3rd Qu.: 1.0000  
 Max.   :20.0000  
 NA's   :1        </code></pre>
</div>
</div>
<p>If by bad luck we have an NA, this is due to the rounding of the crv, so we replace NA with the max value:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sim_temp[<span class="fu">is.na</span>(sim_temp)] <span class="ot">&lt;-</span> <span class="fu">max</span>(actual_var_distr<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sim_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     value       
 Min.   : 0.000  
 1st Qu.: 0.000  
 Median : 0.000  
 Mean   : 0.804  
 3rd Qu.: 1.000  
 Max.   :20.000  </code></pre>
</div>
</div>
<p>Once transformed in this way, our simulated margin matches the observed distribution exactly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actual cumulative distribution for genre = "documentary":</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  actual_var_distr <span class="sc">%&gt;%</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, value, cumpc),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># untransformed simulated cumulative distribution for genre = "documentary":</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">genre =</span> all_genres[i],</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">round</span>(s, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(genre, value) <span class="sc">%&gt;%</span> </span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">cumpc =</span> <span class="fu">cumsum</span>(pc),</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">source =</span> <span class="st">"sim untransformed"</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, value, cumpc),</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transformed simulated cumulative distribution for genre = "documentary":</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> sim_temp</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(value) <span class="sc">%&gt;%</span> </span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">cumpc =</span> <span class="fu">cumsum</span>(pc),</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">source =</span> <span class="st">"sim transformed"</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, value, cumpc)</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">source =</span> <span class="fu">factor</span>(</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    source, </span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"actual"</span>, <span class="st">"sim untransformed"</span>, <span class="st">"sim transformed"</span>))</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> cumpc, <span class="at">col =</span> source)) <span class="sc">+</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"slateblue1"</span>, <span class="st">"violetred"</span>, <span class="st">"darkorange"</span>)) <span class="sc">+</span> </span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>source, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"cumulative distribution for genre = documentary"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The resulting transformed margin in orange matches the actual margin in blue exactly.</p>
<p>Let’s apply this transformation to each margin:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>simulation_fc <span class="ot">&lt;-</span> <span class="cf">function</span>(actual_distr, cor_mat, sample_size){</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' Calculates the items joint reach per weight of usage category.</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#'</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param actual_distr A data frame containing the name, value, n, pc, cumpc for each variable.</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param cor_mat A matrix containing the correlation.</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param sample_size The number of units required for the simulated dataset</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @return The simulated dataset. </span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' </span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  simdata <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> sample_size, </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(cor_mat)), </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sigma =</span> cor_mat</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make copy so we can replace each column with their corrected values:</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  sim_copy <span class="ot">&lt;-</span> simdata</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_mat)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(names)) {</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> sim_copy[, i]</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  actual_var_distr <span class="ot">&lt;-</span> actual_distr <span class="sc">%&gt;%</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">==</span> names[i])</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the critical values so we can map the simulated values to these probabilities:</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>  crv <span class="ot">=</span> <span class="fu">as.vector</span>(<span class="fu">c</span>(<span class="fu">min</span>(s), <span class="fu">quantile</span>(s, actual_var_distr<span class="sc">$</span>cumpc)))</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cut the simulated normal data according to the breaks given by the crv table:</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">cut</span>(</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    s,</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">right =</span> <span class="cn">TRUE</span>,</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> crv,</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> actual_var_distr<span class="sc">$</span>value</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the levels back to numeric values:</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>  sim_temp <span class="ot">&lt;-</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(temp)))</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if by bad luck we have an NA, this may be to do with rounding of the crv...</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># =&gt; replace with the max value:</span></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>  sim_temp[<span class="fu">is.na</span>(sim_temp)] <span class="ot">&lt;-</span> <span class="fu">max</span>(actual_var_distr<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform these levels back into our values:</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>  sim_copy[, i] <span class="ot">&lt;-</span> sim_temp<span class="sc">$</span>value</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.data.frame</span>(sim_copy))</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>sim_db <span class="ot">&lt;-</span> <span class="fu">simulation_fc</span>(</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_distr =</span> actual_distr,</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">cor_mat =</span> spearman_cor,</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="dv">100000</span></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim_db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  action adventure animation childrens comedy crime documentary drama fantasy
1     21        10         1         1     26    12           0    37       0
2      4         2         1         1      6     2           1    14       0
3     16         5         1         4     24     4           0    36       1
4     25        19         2        10     27     4           0    34      12
5     22        16         1         2     19     3           2    19       1
6     38        21         3         4     23     9           0    57       0
  film_noir horror musical mystery romance sci_fi thriller war western
1         2      1       1      11      32     10       23   9       0
2         1      0       1       3       9      2        4   3       0
3         0      4       3       6      20      4       22  12       3
4         1      8       8       4      29     11       14   7       2
5         0      4       0       3       8     14       25   4       0
6         2      4       4       9      55     17       39  17       2</code></pre>
</div>
</div>
<p>Compare simulated mean against actual mean by genre:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>genres_rld_wide <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres)) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(<span class="at">actual =</span> <span class="fu">sum</span>(value)<span class="sc">/</span><span class="fu">nrow</span>(genres_rld_wide)) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  sim_db <span class="sc">%&gt;%</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres)) <span class="sc">%&gt;%</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">sim =</span> <span class="fu">sum</span>(value)<span class="sc">/</span><span class="fu">nrow</span>(sim_db)),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">round</span>(actual <span class="sc">-</span> sim, <span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 4
   name        actual    sim   diff
   &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 action      27.1   27.1   -0.001
 2 adventure   14.5   14.5    0    
 3 animation    3.82   3.82   0    
 4 childrens    7.57   7.58   0    
 5 comedy      31.6   31.6   -0.001
 6 crime        8.51   8.51   0    
 7 documentary  0.804  0.804  0    
 8 drama       41.8   41.8   -0.002
 9 fantasy      1.43   1.43   0    
10 film_noir    1.84   1.84   0    
11 horror       5.60   5.60   0    
12 musical      5.25   5.25   0    
13 mystery      5.55   5.55   0    
14 romance     20.4   20.4    0    
15 sci_fi      13.5   13.5    0    
16 thriller    23.1   23.1   -0.001
17 war          9.97   9.97   0    
18 western      1.97   1.97   0    </code></pre>
</div>
</div>
<p>The simulated dataset preserves the average number of films per person for all genres.</p>
</section>
<section id="univariate-comparison" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="univariate-comparison"><span class="header-section-number">3.1.3</span> univariate comparison</h3>
<p>As we have mapped each <span class="math inline">\(N(0,1)\)</span> margin to the observed marginal distributions, there should be no difference between actual and simulated margins:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  actual_distr <span class="sc">%&gt;%</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>cumpc) <span class="sc">%&gt;%</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  sim_db <span class="sc">%&gt;%</span> </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, value) <span class="sc">%&gt;%</span> </span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pc, <span class="at">col =</span> source)) <span class="sc">+</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"actual vs simulated genre distributions"</span>) <span class="sc">+</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The margins are an exact match (the actual and simulated densities are the same and can’t be distinguished in the above plots) so any subsequent calculations based on summing the values will be preserved.</p>
</section>
<section id="bivariate-comparison" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="bivariate-comparison"><span class="header-section-number">3.1.4</span> bivariate comparison</h3>
<p>To start with, we can compare the Spearman correlations in the original and simulated datasets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actual correlations:</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  spearman_cor <span class="sc">%&gt;%</span> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"genre1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres), <span class="at">names_to =</span> <span class="st">"genre2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(genre1 <span class="sc">&gt;</span> genre2) <span class="sc">%&gt;%</span> </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulated transformed correlations:</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(sim_db, <span class="at">method =</span> <span class="st">"spearman"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"genre1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(all_genres), <span class="at">names_to =</span> <span class="st">"genre2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(genre1 <span class="sc">&gt;</span> genre2) <span class="sc">%&gt;%</span> </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"source"</span>, <span class="at">values_from =</span> <span class="st">"cor"</span>)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(compare_corrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  genre1    genre2    actual   sim
  &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
1 adventure action     0.946 0.939
2 animation action     0.703 0.661
3 animation adventure  0.774 0.733
4 childrens action     0.729 0.704
5 childrens adventure  0.793 0.770
6 childrens animation  0.872 0.837</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="sc">%&gt;%</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim)) <span class="sc">+</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"maroon"</span>) <span class="sc">+</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"genre pairwise Spearman correlations"</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"actual correlations"</span>, <span class="at">y =</span> <span class="st">"simulated correlations"</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that the pairwise correlations are always a little bit lower than their original correlations but they’re still very close.</p>
<p>The correlation is just one summary value for the entire bivariate distribution, but how well did this work in the entire distribution? Do we have the expected percentages in the tails of the bivariate distributions? To illustrate this we create 4 categories for each univariate:<br>
- cat0: non-users.<br>
- cat1: light users (first tertile based on non-null values).<br>
- cat2: medium users (second tertile based on non-null values).<br>
- cat3: heavy users (third tertile based on non-null values).</p>
<p>Then we calculate the percentage reach for all pairs of genres and all categories: P(X = cat0 and Y = cat0) etc…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create all possible pairs of genres:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> all_genres,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> all_genres,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(var1, var2) <span class="sc">%&gt;%</span> </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&lt;</span> var2)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>joint_reach_categories_fc <span class="ot">&lt;-</span> <span class="cf">function</span>(my_grid, actual_db, sim_db, my_source){</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' Calculates the items joint reach per weight of usage category.</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#'</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param my_grid A data frame containing all distinct pairwise combinations.</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param actual_db A data frame containing an id column and one column per item.</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param sim_db A data frame containing one column per item.</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @param my_source A string containing the name of the source.</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' @return The pairwise reach for each item combination and each category. </span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#' </span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  my_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(my_grid)){</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    var1 <span class="ot">&lt;-</span> my_grid<span class="sc">$</span>var1[i]</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>    var2 <span class="ot">&lt;-</span> my_grid<span class="sc">$</span>var2[i]</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    actual_long <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># separate the zeros and assign tertile = 0:</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    actual_db <span class="sc">%&gt;%</span> </span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"id"</span>, var1, var2))) <span class="sc">%&gt;%</span> </span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(var1<span class="sc">:</span>var2, <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>        var <span class="sc">%in%</span> <span class="fu">c</span>(var1, var2),</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        n <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(var) <span class="sc">%&gt;%</span> </span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tertile =</span> <span class="dv">0</span>),</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the tertile of each distribution excluding zero:</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>    actual_db <span class="sc">%&gt;%</span> </span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"id"</span>, var1, var2))) <span class="sc">%&gt;%</span> </span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(var1<span class="sc">:</span>var2, <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>        var <span class="sc">%in%</span> <span class="fu">c</span>(var1, var2),</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>        n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(var) <span class="sc">%&gt;%</span> </span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tertile =</span> <span class="fu">ntile</span>(n, <span class="dv">3</span>))</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>    actual_wide <span class="ot">&lt;-</span> actual_long <span class="sc">%&gt;%</span> </span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> tertile) </span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># same with the results from the simulation:</span></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>  sim_long <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># separate the zeros and assign tertile = 0:</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>    sim_db <span class="sc">%&gt;%</span> </span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"id"</span>, var1, var2))) <span class="sc">%&gt;%</span> </span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(var1<span class="sc">:</span>var2, <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>        var <span class="sc">%in%</span> <span class="fu">c</span>(var1, var2),</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>        n <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(var) <span class="sc">%&gt;%</span> </span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tertile =</span> <span class="dv">0</span>),</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the tertile of each distribution excluding zero:</span></span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>    sim_db <span class="sc">%&gt;%</span> </span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"id"</span>, var1, var2))) <span class="sc">%&gt;%</span> </span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(var1<span class="sc">:</span>var2, <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>        var <span class="sc">%in%</span> <span class="fu">c</span>(var1, var2),</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>        n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(var) <span class="sc">%&gt;%</span> </span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tertile =</span> <span class="fu">ntile</span>(n, <span class="dv">3</span>))</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>    sim_wide <span class="ot">&lt;-</span> sim_long <span class="sc">%&gt;%</span> </span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> tertile) </span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add results to the list:</span></span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a>   my_list[[i]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a>     actual_wide <span class="sc">%&gt;%</span> </span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat0 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">nrow</span>(actual_wide),</span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat1 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">/</span><span class="fu">nrow</span>(actual_wide),</span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat2 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">2</span>)<span class="sc">/</span><span class="fu">nrow</span>(actual_wide),</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat3 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">/</span><span class="fu">nrow</span>(actual_wide)</span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>, <span class="at">var1 =</span> var1, <span class="at">var2 =</span> var2),</span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>     sim_wide <span class="sc">%&gt;%</span> </span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat0 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">nrow</span>(sim_wide),</span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat1 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">/</span><span class="fu">nrow</span>(sim_wide),</span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat2 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">2</span>)<span class="sc">/</span><span class="fu">nrow</span>(sim_wide),</span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">cat3 =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(var1) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var2) <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">/</span><span class="fu">nrow</span>(sim_wide)</span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">source =</span> my_source, <span class="at">var1 =</span> var1, <span class="at">var2 =</span> var2)</span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb65-111"><a href="#cb65-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-112"><a href="#cb65-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(my_list)</span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">joint_reach_categories_fc</span>(</span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_grid =</span> my_grid, </span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual_db =</span> genres_rld_wide, </span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim_db =</span> sim_db,</span>
<span id="cb65-125"><a href="#cb65-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_source =</span> <span class="st">"sim"</span></span>
<span id="cb65-126"><a href="#cb65-126" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     cat0   cat1   cat2  cat3 source var1   var2     
    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;    
1 0.00318 0.266  0.259  0.298 actual action adventure
2 0.00531 0.255  0.228  0.277 sim    action adventure
3 0.00424 0.0976 0.125  0.199 actual action animation
4 0.00522 0.0809 0.0980 0.170 sim    action animation
5 0.00212 0.165  0.154  0.232 actual action childrens
6 0.00492 0.140  0.127  0.201 sim    action childrens</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>cats <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cat"</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>my_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"slateblue"</span>, <span class="st">"cornflowerblue"</span>, <span class="st">"royalblue1"</span>,<span class="st">"thistle"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cats)){</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span> </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"source"</span>, <span class="st">"var1"</span>, <span class="st">"var2"</span>, cats[i]))) <span class="sc">%&gt;%</span> </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">cat =</span> cats[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> source, <span class="at">values_from =</span> cat) <span class="sc">%&gt;%</span> </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim)) <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">col =</span> my_cols[i]) <span class="sc">+</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(cats[i], <span class="st">" : pairwise reach"</span>))</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(p)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When looking at the pairwise distributions we notice that:<br>
- the non-users of both genres (cat0) tend to be slightly over-estimated but not much.<br>
- the heavy-users of both genres (cat3) are systematically under-estimated.</p>
<p>Maybe the Gaussian copula isn’t the best choice for the dependence structure and we could do better with a copula that has a different shape at the tails. Overall this is still very close to the actual bivariate distributions.</p>
</section>
<section id="multivariate-comparison" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="multivariate-comparison"><span class="header-section-number">3.1.5</span> multivariate comparison</h3>
<p>In the previous section we checked the combined reach levels for each pair of genres, but what happens when we calculate the combined reach for 2, 3, 4… all genres? As all users in this dataset have watch at least one drama and one romance film the fully combined reach across all genres will be 1, so let’s start with the smallest genres and add the next bigger genre at each step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>genres_ranking <span class="ot">&lt;-</span> genres_rld <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(genre) <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="at">reach =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(reach)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>genres_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  genre       reach
  &lt;chr&gt;       &lt;int&gt;
1 documentary   352
2 western       491
3 fantasy       512
4 film_noir     618
5 animation     659
6 musical       754</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(genres_ranking)){</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  my_genres_combination <span class="ot">&lt;-</span> genres_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>(i)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  actual_mat <span class="ot">&lt;-</span> genres_rld_wide[, my_genres_combination<span class="sc">$</span>genre]</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  actual_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(actual_mat)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  sim_mat <span class="ot">&lt;-</span> sim_db[, my_genres_combination<span class="sc">$</span>genre]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  sim_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(sim_mat)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  my_list[[i<span class="dv">-1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">genre_combination =</span> <span class="fu">paste</span>(my_genres_combination<span class="sc">$</span>genre, <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">n1 =</span> <span class="fu">ncol</span>(actual_mat),</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n2 =</span> <span class="fu">ncol</span>(sim_mat),</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_pc =</span> <span class="fu">sum</span>(actual_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(actual_comb_sum),</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sim_pc =</span> <span class="fu">sum</span>(sim_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(sim_comb_sum)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>multivariate_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(my_list) </span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>multivariate_comparison <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>n1, <span class="sc">-</span>n2) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                    genre_combination actual_pc  sim_pc
1                                documentary, western 0.6277837 0.63941
2                       documentary, western, fantasy 0.7391304 0.74815
3            documentary, western, fantasy, film_noir 0.8600212 0.84687
4 documentary, western, fantasy, film_noir, animation 0.9353128 0.89748</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>multivariate_comparison <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual_pc,  <span class="at">y =</span> sim_pc)) <span class="sc">+</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"slateblue"</span>) <span class="sc">+</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"V1: actual vs simulated combined reach"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For the first couple of combinations the simulated result are slightly bigger that the actual combined reach but after that, we go in the other direction and the simulated result is slightly lower than the actual result. Note that as everyone in this dataset has watched at least one film, we get to 100% reach when looking across all genres.</p>
</section>
<section id="conclusion" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">3.1.6</span> conclusion</h3>
<p>In this section we demonstrated how we can recreate a simulation of a multivariate discrete distribution with a Gaussian copula using just their Spearman correlation and their empirical cumulative marginal distributions. The resulting simulation has margins that match the original ones exactly, so there is no loss of volume (in this case the total number of films watched), and the multivariate relationships have also been very well preserved.</p>
</section>
</section>
<section id="example-using-radio-listening-dataset" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="example-using-radio-listening-dataset"><span class="header-section-number">3.2</span> example using radio listening dataset</h2>
<p>When working with media usage, distributions typically exhibit a high level of zero for the non-users. Here we show what happens when using the Spearman correlation and we compare it with the results using the Tetrachoric correlation.</p>
<p>In media planning, the negative binomial distribution (NBD) is widely use for Reach and Frequency models, based on the work of Mr A.S.C. Ehrenberg <span class="citation" data-cites="ehrenberg">(<a href="#ref-ehrenberg" role="doc-biblioref">Ehrenberg 1959</a>)</span>. When fitting the NBD, the method typically used is not the method of moments or of maximum likelihood, but is based on preserving the probability at zero <span class="math inline">\(P(X)=0\)</span> and the total volume (e.g.&nbsp;total impressions, purchases, …) via the mean. In doing so, the currencies are preserved (no loss in volume) and so is the observed reach. It is with these same objectives in mind of preserving reach and volume that the following approach is also based.</p>
<p>In this example, the dataset was created using R’s <code>synthpop</code> package <span class="citation" data-cites="synthpop">(<a href="#ref-synthpop" role="doc-biblioref">Dibben 2016</a>)</span> and is based on the radio listening (time spent in minutes) of 11 stations from RAJAR data from 2019Q1. It contains 100k synthetic respondents and is available from <a href="https://github.com/bbc/insights-christel-tasks/blob/master/simulation/cross_media_usage_with_copulas/syn_listening_db.csv">github</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"syn_listening_db.csv"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id              st1               st2                st3        
 Min.   :     1   Min.   :   0.00   Min.   :   0.000   Min.   :   0.0  
 1st Qu.: 25001   1st Qu.:   0.00   1st Qu.:   0.000   1st Qu.:   0.0  
 Median : 50000   Median :   0.00   Median :   0.000   Median :   0.0  
 Mean   : 50000   Mean   :  61.94   Mean   :   3.532   Mean   : 229.6  
 3rd Qu.: 75000   3rd Qu.:   0.00   3rd Qu.:   0.000   3rd Qu.: 120.0  
 Max.   :100000   Max.   :7530.00   Max.   :5640.000   Max.   :7830.0  
      st4               st5              st6               st7         
 Min.   :   0.00   Min.   :   0.0   Min.   :   0.00   Min.   :   0.00  
 1st Qu.:   0.00   1st Qu.:   0.0   1st Qu.:   0.00   1st Qu.:   0.00  
 Median :   0.00   Median :   0.0   Median :   0.00   Median :   0.00  
 Mean   :  15.76   Mean   : 153.3   Mean   :  16.62   Mean   :  42.46  
 3rd Qu.:   0.00   3rd Qu.:   0.0   3rd Qu.:   0.00   3rd Qu.:   0.00  
 Max.   :6495.00   Max.   :7695.0   Max.   :5640.00   Max.   :5895.00  
      st8                st9               st10               st11         
 Min.   :   0.000   Min.   :   0.00   Min.   :   0.000   Min.   :   0.000  
 1st Qu.:   0.000   1st Qu.:   0.00   1st Qu.:   0.000   1st Qu.:   0.000  
 Median :   0.000   Median :   0.00   Median :   0.000   Median :   0.000  
 Mean   :   4.179   Mean   :  26.68   Mean   :   1.768   Mean   :   8.761  
 3rd Qu.:   0.000   3rd Qu.:   0.00   3rd Qu.:   0.000   3rd Qu.:   0.000  
 Max.   :1965.000   Max.   :6360.00   Max.   :4200.000   Max.   :5745.000  </code></pre>
</div>
</div>
<p>Given just a correlation matrix and the empirical marginal cumulative distributions, can we recreate a simulated dataset that preserves the multivariate distribution of the original dataset?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">names</span>(db)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(db)]</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span> </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"station"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">station =</span> <span class="fu">factor</span>(station, <span class="at">levels =</span> stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station) <span class="sc">%&gt;%</span> </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">reach_pc =</span> <span class="fu">sum</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> reach_pc, <span class="at">y =</span> station)) <span class="sc">+</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"slateblue"</span>) <span class="sc">+</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">limits=</span>rev) <span class="sc">+</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Radio: reach% by station"</span>, <span class="at">x =</span> <span class="st">"reach%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then for each station what is the distribution of time spent in minutes?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>actual_distr <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name, value) <span class="sc">%&gt;%</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pc =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumpc =</span> <span class="fu">cumsum</span>(pc)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(actual_distr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
# Groups:   name [1]
  name  value     n      pc cumpc
  &lt;chr&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 st1       0 83461 0.835   0.835
2 st1       5     9 0.00009 0.835
3 st1       7    56 0.00056 0.835
4 st1      10     9 0.00009 0.835
5 st1      12     4 0.00004 0.835
6 st1      15   916 0.00916 0.845</code></pre>
</div>
</div>
<p>Plot the distribution of the margins, excluding zeros:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>actual_distr <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hours =</span> <span class="fu">cut</span>(value<span class="sc">/</span><span class="dv">60</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">135</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name, hours) <span class="sc">%&gt;%</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hours, <span class="at">y =</span> n, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>()</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"radio: distribution of number of hours (excl. zero)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/marginal barplots-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The distribution of time spent is similar for all stations: it dies away quickly and has a long tail.</p>
<section id="using-spearman-correlation" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="using-spearman-correlation"><span class="header-section-number">3.2.1</span> using Spearman correlation</h3>
<p>To create a simulation of the radio dataset, we first calculate its Spearman correlation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>spearman_cor <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(<span class="at">method =</span> <span class="st">"spearman"</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>spearman_cor[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            st1          st2          st3          st4         st5
st1  1.00000000  0.102310851 -0.038459515 -0.045758896 -0.11805906
st2  0.10231085  1.000000000 -0.042944399 -0.008787423 -0.03534992
st3 -0.03845952 -0.042944399  1.000000000 -0.009515269  0.04626172
st4 -0.04575890 -0.008787423 -0.009515269  1.000000000  0.26083401
st5 -0.11805906 -0.035349917  0.046261723  0.260834006  1.00000000</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>spearman_cor_db <span class="ot">&lt;-</span> spearman_cor <span class="sc">%&gt;%</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"var1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"var2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&gt;</span> var2)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check genres with the lowest correlations:</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>spearman_cor_db <span class="sc">%&gt;%</span> </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(cor)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  var1  var2    cor
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 st6   st5   0.306
2 st8   st7   0.298
3 st5   st4   0.261
4 st5   st11  0.255
5 st6   st11  0.156
6 st4   st11  0.137</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(spearman_cor_db<span class="sc">$</span>cor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.118059 -0.009163  0.024514  0.042897  0.064182  0.305998 </code></pre>
</div>
</div>
<p>Next, we create a simulation using 100k sampling units from a multivariate Normal using these observed correlations and we map the cumulative distributions of these <span class="math inline">\(N(0,1)\)</span> margins to the observed cumulative distributions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>radio_sim_db_v1 <span class="ot">&lt;-</span> <span class="fu">simulation_fc</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_distr =</span> actual_distr,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cor_mat =</span> spearman_cor,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="dv">100000</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(radio_sim_db_v1) <span class="ot">&lt;-</span> stations</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>radio_sim_db_v1[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  st1 st2 st3 st4 st5
1   0   0   0   0   0
2   0   0   0   0   0
3   0   0   0   0   0
4   0   0 180   0   0
5   0   0 195   0 840</code></pre>
</div>
</div>
<p>Check simulated reach% against actual reach%:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">sim =</span> <span class="fu">colSums</span>(radio_sim_db_v1 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">nrow</span>(radio_sim_db_v1)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"name"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    actual_distr <span class="sc">%&gt;%</span> </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">actual =</span> <span class="dv">1</span><span class="sc">-</span>pc) <span class="sc">%&gt;%</span> </span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(name, actual) ,</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">round</span>(sim <span class="sc">-</span> actual, <span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   name     sim  actual diff
1   st1 0.16539 0.16539    0
2   st2 0.01276 0.01276    0
3   st3 0.32480 0.32480    0
4   st4 0.04112 0.04112    0
5   st5 0.22966 0.22966    0
6   st6 0.04284 0.04284    0
7   st7 0.10477 0.10477    0
8   st8 0.02128 0.02128    0
9   st9 0.04773 0.04773    0
10 st10 0.00665 0.00665    0
11 st11 0.02895 0.02895    0</code></pre>
</div>
</div>
<p>Check simulated total hours against actual total hours:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span> </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">actual =</span> <span class="fu">round</span>(<span class="fu">sum</span>(value<span class="sc">/</span><span class="dv">60</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    radio_sim_db_v1 <span class="sc">%&gt;%</span> </span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">sim =</span> <span class="fu">round</span>(<span class="fu">sum</span>(value<span class="sc">/</span><span class="dv">60</span>))),</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> actual <span class="sc">-</span> sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 4
   name  actual    sim  diff
   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 st1   103230 103230     0
 2 st10    2946   2946     0
 3 st11   14602  14602     0
 4 st2     5887   5887     0
 5 st3   382685 382685     0
 6 st4    26262  26262     0
 7 st5   255475 255475     0
 8 st6    27703  27703     0
 9 st7    70762  70762     0
10 st8     6965   6965     0
11 st9    44461  44461     0</code></pre>
</div>
</div>
<p>The simulated dataset match the reach and total hours of the actual dataset for all stations.</p>
<section id="univariate-comparison-1" class="level4" data-number="3.2.1.1">
<h4 data-number="3.2.1.1" class="anchored" data-anchor-id="univariate-comparison-1"><span class="header-section-number">3.2.1.1</span> univariate comparison</h4>
<p>As we have mapped each <span class="math inline">\(N(0,1)\)</span> margin to the observed marginal distributions, there should be no difference between actual and simulated margins:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  db <span class="sc">%&gt;%</span> </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  radio_sim_db_v1 <span class="sc">%&gt;%</span> </span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>, value <span class="sc">&lt;</span> <span class="dv">600</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">col =</span> source)) <span class="sc">+</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name,  <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"actual vs simulated genre distributions"</span>) <span class="sc">+</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>As expected, margins are an exact match (the actual and simulated densities can’t be distinguished in the above plot) so any subsequent calculations based on summing the values will be preserved.</p>
</section>
<section id="bivariate-comparison-1" class="level4" data-number="3.2.1.2">
<h4 data-number="3.2.1.2" class="anchored" data-anchor-id="bivariate-comparison-1"><span class="header-section-number">3.2.1.2</span> bivariate comparison</h4>
<p>To start with, we can compare the Spearman correlations in the original and simulated datasets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actual correlations:</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  spearman_cor <span class="sc">%&gt;%</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"var1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"var2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(var1 <span class="sc">&gt;</span> var2) <span class="sc">%&gt;%</span> </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulated transformed correlations:</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(radio_sim_db_v1, <span class="at">method =</span> <span class="st">"spearman"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"var1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"var2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(var1 <span class="sc">&gt;</span> var2) <span class="sc">%&gt;%</span> </span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"source"</span>, <span class="at">values_from =</span> <span class="st">"cor"</span>)</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(compare_corrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  var1  var2    actual      sim
  &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 st2   st1    0.102    0.0241 
2 st2   st10   0.0487   0.00269
3 st2   st11   0.00275  0.00322
4 st3   st1   -0.0385  -0.0205 
5 st3   st2   -0.0429  -0.00666
6 st3   st10  -0.0369  -0.00816</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="sc">%&gt;%</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim)) <span class="sc">+</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"maroon"</span>) <span class="sc">+</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.3</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"V1: genre pairwise Spearman correlations"</span>,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"actual correlations"</span>, <span class="at">y =</span> <span class="st">"simulated correlations"</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that the simulated pairwise correlations have a much smaller span compared with original correlations.</p>
<p>Next we can check the bivariate results for each pair of stations. To do this, we create 4 categories for each univariate:<br>
- cat0: non-users.<br>
- cat1: light users (first tertile based on non-null values).<br>
- cat2: medium users (second tertile based on non-null values).<br>
- cat3: heavy users (third tertile based on non-null values).</p>
<p>Then we calculate the percentage reach for all pairs of genres and all categories: P(X = cat0 and Y = cat0) etc…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create all possible pairs of genres:</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> stations,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> stations,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(var1, var2) <span class="sc">%&gt;%</span> </span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&lt;</span> var2)</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>results_v1 <span class="ot">&lt;-</span> <span class="fu">joint_reach_categories_fc</span>(</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_grid =</span> my_grid, </span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual_db =</span> db, </span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim_db =</span> radio_sim_db_v1,</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_source =</span> <span class="st">"sim_v1"</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(results_v1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
   cat0    cat1    cat2    cat3 source var1  var2 
  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
1 0.829 0.00033 0.00018 0.00012 actual st1   st10 
2 0.829 0.00015 0.0001  0.00016 sim_v1 st1   st10 
3 0.808 0.00057 0.00028 0.00015 actual st1   st11 
4 0.810 0.0005  0.0006  0.00037 sim_v1 st1   st11 
5 0.828 0.00106 0.00085 0.0008  actual st1   st2  
6 0.825 0.00032 0.00034 0.00038 sim_v1 st1   st2  </code></pre>
</div>
</div>
<p>Note that as we have high levels of zeros, the remaining listening weight categories are actually really small.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>cats <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cat"</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>my_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"slateblue"</span>, <span class="st">"cornflowerblue"</span>, <span class="st">"royalblue1"</span>,<span class="st">"thistle"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cats)){</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> results_v1 <span class="sc">%&gt;%</span> </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"source"</span>, <span class="st">"var1"</span>, <span class="st">"var2"</span>, cats[i]))) <span class="sc">%&gt;%</span> </span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">cat =</span> cats[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> source, <span class="at">values_from =</span> cat) <span class="sc">%&gt;%</span> </span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim_v1)) <span class="sc">+</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">col =</span> my_cols[i]) <span class="sc">+</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(cats[i], <span class="st">" : pairwise reach"</span>))</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(p)</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-57-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-57-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-57-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When looking at the pairwise distributions we notice that:<br>
- the non-users of both genres (cat0) are well aligned with small differences.<br>
- the light-users of both genres (cat1) are systematically under-estimated.</p>
<p>There is quite a spread in the weight of listening categories but these are based on very small sample size, and what matters most are the combined zero categories.</p>
</section>
<section id="multivariate-comparison-1" class="level4" data-number="3.2.1.3">
<h4 data-number="3.2.1.3" class="anchored" data-anchor-id="multivariate-comparison-1"><span class="header-section-number">3.2.1.3</span> multivariate comparison</h4>
<p>What happens when we calculate the reach for 2, 3, 4… all genres? let’s start with the smallest genres and add the next bigger genre at each step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>station_ranking <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="at">reach =</span> <span class="fu">sum</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) ) <span class="sc">%&gt;%</span>  </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(reach))</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>my_stations <span class="ot">&lt;-</span> station_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">2</span>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>my_stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  name  reach
  &lt;chr&gt; &lt;int&gt;
1 st3   32480
2 st5   22966</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(station_ranking)){</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  my_stations <span class="ot">&lt;-</span> station_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>(i)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  actual_mat <span class="ot">&lt;-</span> db[, my_stations<span class="sc">$</span>name]</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>  actual_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(actual_mat)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  sim_mat <span class="ot">&lt;-</span> radio_sim_db_v1[, my_stations<span class="sc">$</span>name]</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>  sim_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(sim_mat)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  my_list[[i<span class="dv">-1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">genre_combination =</span> <span class="fu">paste</span>(my_stations<span class="sc">$</span>name, <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">n1 =</span> <span class="fu">ncol</span>(actual_mat),</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n2 =</span> <span class="fu">ncol</span>(sim_mat),</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_pc =</span> <span class="fu">sum</span>(actual_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(actual_comb_sum),</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sim_pc =</span> <span class="fu">sum</span>(sim_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(sim_comb_sum)</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>multivariate_v1 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(my_list) </span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>multivariate_v1 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  genre_combination n1 n2 actual_pc  sim_pc
1                          st3, st5  2  2   0.46381 0.47550
2                     st3, st5, st1  3  3   0.56756 0.57095
3                st3, st5, st1, st7  4  4   0.59904 0.61112
4           st3, st5, st1, st7, st9  5  5   0.60775 0.62575
5      st3, st5, st1, st7, st9, st6  6  6   0.61062 0.63658
6 st3, st5, st1, st7, st9, st6, st4  7  7   0.61525 0.64859</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>multivariate_v1 <span class="sc">%&gt;%</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual_pc,  <span class="at">y =</span> sim_pc)) <span class="sc">+</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"slateblue"</span>) <span class="sc">+</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"V1: actual vs simulated combined reach"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>=&gt; as we increase the number of stations past the first 3, the simulated result gets progressively higher than the actual result as we are accumlating error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(multivariate_v1, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                         genre_combination n1 n2 actual_pc
10 st3, st5, st1, st7, st9, st6, st4, st11, st8, st2, st10 11 11   0.62651
    sim_pc
10 0.66793</code></pre>
</div>
</div>
<p>When we combine the reach across all stations, the actual reach is 62.7% but the simulated reach is higher at 66.8%.</p>
</section>
</section>
<section id="using-tetrachoric-correlation" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="using-tetrachoric-correlation"><span class="header-section-number">3.2.2</span> using Tetrachoric correlation</h3>
<p>The <strong>polychoric</strong> correlation is a technique for estimating the correlation between two hypothesised normally distributed continuous latent variables, from two observed ordinal variables. <strong>Tetrachoric</strong> correlation is a special case of the polychoric correlation applicable when both observed variables are dichotomous. (source: wikipedia).</p>
<p>In R, we can use the convenient function <code>psych::phi2tetra</code> to find the Tetrachoric correlation that corresponds to the combination of a “Phi coefficient”, i.e.&nbsp;the correlation between the two binary vectors, as well as their marginals.</p>
<p>Calculate the tetrachoric correlation for all pairs of genres that include the zero value:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create all possible pairs of genres:</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>all_pairs <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> stations,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> stations,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(var1, var2) <span class="sc">%&gt;%</span> </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&lt;</span> var2) <span class="sc">%&gt;%</span> </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi_coef =</span> <span class="cn">NA</span>,</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcc =</span> <span class="cn">NA</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_pairs)){</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(db)</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  v1 <span class="ot">&lt;-</span> all_pairs<span class="sc">$</span>var1[i]</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  v2 <span class="ot">&lt;-</span> all_pairs<span class="sc">$</span>var2[i]</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform the 1st genre to binary:</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(v1)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">v1 =</span> <span class="sc">!!</span><span class="fu">sym</span>(v1)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">v1 =</span> <span class="fu">ifelse</span>(v1 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(v1)</span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform the 2nd genre to binary:</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(v2)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">v2 =</span> <span class="sc">!!</span><span class="fu">sym</span>(v2)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">v2 =</span> <span class="fu">ifelse</span>(v2 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(v2)</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the phi coefficient:</span></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>  all_pairs<span class="sc">$</span>phi_coef[i] <span class="ot">&lt;-</span> <span class="fu">cor</span>(x1, x2)</span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to tetrachoric correlation:</span></span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>  all_pairs<span class="sc">$</span>tcc[i] <span class="ot">&lt;-</span> <span class="fu">phi2tetra</span>(</span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">ph =</span> <span class="fu">cor</span>(x1, x2), </span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">m =</span> <span class="fu">c</span>(<span class="fu">mean</span>(x1), <span class="fu">mean</span>(x2))</span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a>all_pairs <span class="sc">%&gt;%</span> </span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(tcc)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  var1 var2  phi_coef       tcc
1  st7  st8 0.2982160 0.7090633
2  st5  st6 0.2977637 0.6823495
3 st11  st5 0.2345534 0.6246644
4  st4  st5 0.2533079 0.5997845
5 st11  st6 0.1552139 0.4537150
6 st11  st4 0.1369527 0.4209029</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(all_pairs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     var1               var2              phi_coef              tcc          
 Length:55          Length:55          Min.   :-0.107399   Min.   :-0.24995  
 Class :character   Class :character   1st Qu.:-0.006035   1st Qu.:-0.03358  
 Mode  :character   Mode  :character   Median : 0.025025   Median : 0.10832  
                                       Mean   : 0.045090   Mean   : 0.12410  
                                       3rd Qu.: 0.066445   3rd Qu.: 0.25108  
                                       Max.   : 0.298216   Max.   : 0.70906  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>all_pairs <span class="sc">%&gt;%</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> phi_coef, <span class="at">y =</span> tcc)) <span class="sc">+</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"darkorange"</span>) <span class="sc">+</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"V1: actual vs simulated combined reach"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Tetrachoric correlations have a larger span than the Phi coefficients.</p>
<p>Turn into a matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add 1 for the ycc between same station pairs:</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>diag <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> stations,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> stations,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tcc =</span> <span class="dv">1</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>tcc_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper triangle:</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  all_pairs <span class="sc">%&gt;%</span> </span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>phi_coef),</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># diagonal of 1s:</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  diag,</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower triangle obtained by inversing genre1 and genre2:</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  all_pairs <span class="sc">%&gt;%</span> </span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>phi_coef) <span class="sc">%&gt;%</span> </span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">var2 =</span> var1,</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">var1 =</span> var2</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(var1, var2, tcc)</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(var1, var2)</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>tcc_cor <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>  tcc_df <span class="sc">%&gt;%</span> </span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure the variables are in the correct order:</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">var1 =</span> <span class="fu">factor</span>(var1, <span class="at">levels =</span> stations),</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">var2 =</span> <span class="fu">factor</span>(var2, <span class="at">levels =</span> stations)</span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(var1, var2) <span class="sc">%&gt;%</span> </span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var2, <span class="at">values_from =</span> tcc) <span class="sc">%&gt;%</span> </span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>var1)</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>tcc_cor[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             st1        st2         st3         st4        st5
[1,]  1.00000000  0.3762087 -0.03229833 -0.17018040 -0.2445209
[2,]  0.37620871  1.0000000 -0.20342287 -0.07833120 -0.1923967
[3,] -0.03229833 -0.2034229  1.00000000  0.01393292  0.1434055
[4,] -0.17018040 -0.0783312  0.01393292  1.00000000  0.5997845
[5,] -0.24452090 -0.1923967  0.14340546  0.59978449  1.0000000</code></pre>
</div>
</div>
<p>Check that this is a valid correlation matrix, i.e.&nbsp;its eigen values are non-negative:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eigen</span>(tcc_cor)<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 3.2053364 1.6814288 1.4463485 1.0975162 0.7858067 0.6941503 0.6168792
 [8] 0.5146659 0.4935429 0.2795524 0.1847726</code></pre>
</div>
</div>
<p>If they are not all positive, we can return the nearest positive definite matrix with <code>Matrix::nearPD</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="fu">sum</span>(<span class="fu">eigen</span>(tcc_cor)<span class="sc">$</span>values <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&lt;</span> <span class="fu">nrow</span>(tcc_cor)){</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    tcc_cor <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">nearPD</span>(tcc_cor, <span class="at">corr =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>mat)</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>tcc_cor[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             st1        st2         st3         st4        st5
[1,]  1.00000000  0.3762087 -0.03229833 -0.17018040 -0.2445209
[2,]  0.37620871  1.0000000 -0.20342287 -0.07833120 -0.1923967
[3,] -0.03229833 -0.2034229  1.00000000  0.01393292  0.1434055
[4,] -0.17018040 -0.0783312  0.01393292  1.00000000  0.5997845
[5,] -0.24452090 -0.1923967  0.14340546  0.59978449  1.0000000</code></pre>
</div>
</div>
<p>Then generate the MVN with the tccs instead of the correlations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>radio_sim_db_v2 <span class="ot">&lt;-</span> <span class="fu">simulation_fc</span>(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_distr =</span> actual_distr,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cor_mat =</span> tcc_cor,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="dv">100000</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(radio_sim_db_v2) <span class="ot">&lt;-</span> stations</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>radio_sim_db_v2[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  st1 st2 st3 st4 st5
1   0   0   0   0  45
2   0   0   0   0   0
3  90   0 255   0   0
4   0   0   0   0   0
5   0   0 135   0   0</code></pre>
</div>
</div>
<p>Check simulated reach% against actual reach%:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">sim =</span> <span class="fu">colSums</span>(radio_sim_db_v2 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">nrow</span>(radio_sim_db_v2)) <span class="sc">%&gt;%</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"name"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    actual_distr <span class="sc">%&gt;%</span> </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">actual =</span> <span class="dv">1</span><span class="sc">-</span>pc) <span class="sc">%&gt;%</span> </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(name, actual) ,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">round</span>(sim <span class="sc">-</span> actual, <span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   name     sim  actual diff
1   st1 0.16539 0.16539    0
2   st2 0.01276 0.01276    0
3   st3 0.32480 0.32480    0
4   st4 0.04112 0.04112    0
5   st5 0.22966 0.22966    0
6   st6 0.04284 0.04284    0
7   st7 0.10477 0.10477    0
8   st8 0.02128 0.02128    0
9   st9 0.04773 0.04773    0
10 st10 0.00665 0.00665    0
11 st11 0.02895 0.02895    0</code></pre>
</div>
</div>
<p>Check simulated total hours against actual total hours:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">actual =</span> <span class="fu">round</span>(<span class="fu">sum</span>(value<span class="sc">/</span><span class="dv">60</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    radio_sim_db_v2 <span class="sc">%&gt;%</span> </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">sim =</span> <span class="fu">round</span>(<span class="fu">sum</span>(value<span class="sc">/</span><span class="dv">60</span>))),</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> actual <span class="sc">-</span> sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 4
   name  actual    sim  diff
   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 st1   103230 103230     0
 2 st10    2946   2946     0
 3 st11   14602  14602     0
 4 st2     5887   5887     0
 5 st3   382685 382685     0
 6 st4    26262  26262     0
 7 st5   255475 255475     0
 8 st6    27703  27703     0
 9 st7    70762  70762     0
10 st8     6965   6965     0
11 st9    44461  44461     0</code></pre>
</div>
</div>
<p>The simulated dataset match the reach and total hours of the actual dataset for all stations.</p>
<section id="univariate-comparison-2" class="level4" data-number="3.2.2.1">
<h4 data-number="3.2.2.1" class="anchored" data-anchor-id="univariate-comparison-2"><span class="header-section-number">3.2.2.1</span> univariate comparison</h4>
<p>As we have mapped each <span class="math inline">\(N(0,1)\)</span> margin to the observed marginal distributions, there should be no difference between actual and simulated margins:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  db <span class="sc">%&gt;%</span> </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  radio_sim_db_v2 <span class="sc">%&gt;%</span> </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>, value <span class="sc">&lt;</span> <span class="dv">600</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">col =</span> source)) <span class="sc">+</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"V2: actual vs simulated genre distributions"</span>) <span class="sc">+</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>As expected, margins are an exact match so any subsequent calculations based on summing the values will be preserved.</p>
</section>
<section id="bivariate-comparison-2" class="level4" data-number="3.2.2.2">
<h4 data-number="3.2.2.2" class="anchored" data-anchor-id="bivariate-comparison-2"><span class="header-section-number">3.2.2.2</span> bivariate comparison</h4>
<p>To start with, we can compare the Spearman correlations in the original and simulated datasets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actual correlations:</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  spearman_cor <span class="sc">%&gt;%</span> </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"var1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"var2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(var1 <span class="sc">&gt;</span> var2) <span class="sc">%&gt;%</span> </span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"actual"</span>),</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulated transformed correlations:</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(radio_sim_db_v2, <span class="at">method =</span> <span class="st">"spearman"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="st">"var1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations), <span class="at">names_to =</span> <span class="st">"var2"</span>, <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(var1 <span class="sc">&gt;</span> var2) <span class="sc">%&gt;%</span> </span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"sim"</span>)</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"source"</span>, <span class="at">values_from =</span> <span class="st">"cor"</span>)</span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(compare_corrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  var1  var2    actual      sim
  &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 st2   st1    0.102    0.107  
2 st2   st10   0.0487   0.0500 
3 st2   st11   0.00275  0.00425
4 st3   st1   -0.0385  -0.0131 
5 st3   st2   -0.0429  -0.0444 
6 st3   st10  -0.0369  -0.0334 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>compare_corrs <span class="sc">%&gt;%</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim)) <span class="sc">+</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"maroon"</span>) <span class="sc">+</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.3</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"V2: genre pairwise Spearman correlations"</span>,</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"actual correlations"</span>, <span class="at">y =</span> <span class="st">"simulated correlations"</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Previously we saw that when using the Spearman correlations the resulting simulated correlations had a much smaller span compared with original correlations. When we switch to the Tetrachoric correlation, the resulting simulated correlations are much closer to the actual ones.</p>
<p>Next we can check the bivariate results for each pair of stations. To do this, we create 4 categories for each univariate:<br>
- cat0: non-users.<br>
- cat1: light users (first tertile based on non-null values).<br>
- cat2: medium users (second tertile based on non-null values).<br>
- cat3: heavy users (third tertile based on non-null values).</p>
<p>Then we calculate the percentage reach for all pairs of genres and all categories: P(X = cat0 and Y = cat0) etc…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create all possible pairs of genres:</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> stations,</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> stations,</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(var1, var2) <span class="sc">%&gt;%</span> </span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&lt;</span> var2)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>results_v2 <span class="ot">&lt;-</span> <span class="fu">joint_reach_categories_fc</span>(</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_grid =</span> my_grid, </span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual_db =</span> db, </span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim_db =</span> radio_sim_db_v2,</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">my_source =</span> <span class="st">"sim_v2"</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(results_v2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
   cat0    cat1    cat2    cat3 source var1  var2 
  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
1 0.829 0.00033 0.00018 0.00012 actual st1   st10 
2 0.829 0.00019 0.00012 0.0002  sim_v2 st1   st10 
3 0.808 0.00057 0.00028 0.00015 actual st1   st11 
4 0.808 0.00027 0.00025 0.00022 sim_v2 st1   st11 
5 0.828 0.00106 0.00085 0.0008  actual st1   st2  
6 0.828 0.00049 0.00041 0.00113 sim_v2 st1   st2  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>cats <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cat"</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>my_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"slateblue"</span>, <span class="st">"cornflowerblue"</span>, <span class="st">"royalblue1"</span>,<span class="st">"thistle"</span>)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cats)){</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> results_v2 <span class="sc">%&gt;%</span> </span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"source"</span>, <span class="st">"var1"</span>, <span class="st">"var2"</span>, cats[i]))) <span class="sc">%&gt;%</span> </span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">cat =</span> cats[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> source, <span class="at">values_from =</span> cat) <span class="sc">%&gt;%</span> </span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> sim_v2)) <span class="sc">+</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">col =</span> my_cols[i]) <span class="sc">+</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(cats[i], <span class="st">" : pairwise reach"</span>))</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(p)</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-75-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-75-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-75-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>=&gt; when looking at the pairwise distributions we notice that:<br>
- the non-users of both stations (cat0) are well aligned with almost zero differences.<br>
- the light-users of both stations (cat1) are systematically under-estimated but this is based on very small sample sizes.</p>
</section>
<section id="multivariate-comparison-2" class="level4" data-number="3.2.2.3">
<h4 data-number="3.2.2.3" class="anchored" data-anchor-id="multivariate-comparison-2"><span class="header-section-number">3.2.2.3</span> multivariate comparison</h4>
<p>What happens when we calculate the reach for 2, 3, 4… all genres? let’s start with the smallest genres and add the next bigger genre at each step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>station_ranking <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">all_of</span>(stations)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="at">reach =</span> <span class="fu">sum</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) ) <span class="sc">%&gt;%</span>  </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(reach))</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>my_stations <span class="ot">&lt;-</span> station_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">2</span>)</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>my_stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  name  reach
  &lt;chr&gt; &lt;int&gt;
1 st3   32480
2 st5   22966</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(station_ranking)){</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  my_stations <span class="ot">&lt;-</span> station_ranking <span class="sc">%&gt;%</span> <span class="fu">head</span>(i)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  actual_mat <span class="ot">&lt;-</span> db[, my_stations<span class="sc">$</span>name]</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  actual_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(actual_mat)</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  sim_mat <span class="ot">&lt;-</span> radio_sim_db_v2[, my_stations<span class="sc">$</span>name]</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  sim_comb_sum <span class="ot">&lt;-</span>  <span class="fu">rowSums</span>(sim_mat)</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>  my_list[[i<span class="dv">-1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">genre_combination =</span> <span class="fu">paste</span>(my_stations<span class="sc">$</span>name, <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">n1 =</span> <span class="fu">ncol</span>(actual_mat),</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n2 =</span> <span class="fu">ncol</span>(sim_mat),</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_pc =</span> <span class="fu">sum</span>(actual_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(actual_comb_sum),</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sim_pc =</span> <span class="fu">sum</span>(sim_comb_sum <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">length</span>(sim_comb_sum)</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>multivariate_v2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(my_list) </span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>multivariate_v2 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  genre_combination n1 n2 actual_pc  sim_pc
1                          st3, st5  2  2   0.46381 0.46432
2                     st3, st5, st1  3  3   0.56756 0.56544
3                st3, st5, st1, st7  4  4   0.59904 0.59791
4           st3, st5, st1, st7, st9  5  5   0.60775 0.60753
5      st3, st5, st1, st7, st9, st6  6  6   0.61062 0.61133
6 st3, st5, st1, st7, st9, st6, st4  7  7   0.61525 0.61713</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>multivariate_v2 <span class="sc">%&gt;%</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual_pc,  <span class="at">y =</span> sim_pc)) <span class="sc">+</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"slateblue"</span>) <span class="sc">+</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>,  <span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"V2: actual vs simulated combined reach"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we increase the number of stations the simulated combined reach remains very close to the actual combined reach which is a much better result than when using the Speaerman correlation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(multivariate_v2, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                         genre_combination n1 n2 actual_pc
10 st3, st5, st1, st7, st9, st6, st4, st11, st8, st2, st10 11 11   0.62651
    sim_pc
10 0.62896</code></pre>
</div>
</div>
<p>When we combine the reach across all stations, the actual reach is 62.7% and now the simulated reach is 62.9% which is much better than when we used Spearman correlation.</p>
<p>Note that although this analysis is based on a synthetic dataset, the exact same results were found with the original RAJAR data.</p>
</section>
</section>
<section id="conclusion-1" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="conclusion-1"><span class="header-section-number">3.2.3</span> conclusion</h3>
<p>Starting with a random sample generated from a multivariate normal using the Tetrachoric correlations between all stations, each resulting margin was then transformed to match the observed time spent distribution for each station using their empirical quantiles.</p>
<p>The resulting simulated dataset preserved all pairs joint reach but also the combined reach from any number of stations. It also preserved the total time spent for all stations. The joint distribution of light / medium / heavy listening was reasonable but is based on much smaller sample sizes.</p>
<p>The main objectives of media planning are to preserve combined reach and total volumes. When using data fusion, any resulting differences in the currencies are corrected through calibration, however the same cannot be done for the reach. Using copulas, there is no need for calibration and the combined reach is preserved.</p>
</section>
</section>
<section id="application-to-measuring-local-cross-media-usage" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="application-to-measuring-local-cross-media-usage"><span class="header-section-number">3.3</span> application to measuring local cross media usage</h2>
<p>In practice of course we don’t have a single source currency multi-media dataset but we may still have some relevant cross-media information that we want to incorporate.</p>
<p>When trying to join distributions from different data sources, the easiest approach is to assume they are independent, then the joint zero is just the product of the individual zeros: <span class="math inline">\(P(X_1 = 0, X_2 = 0) = P(X_1 = 0) P(X_2 = 0)\)</span>. In media planning, this is referred to as the <strong>Sainsbury formula</strong>. However we may have evidence from a separate study that two media are in fact dependent and the problem is then to find a way of incorporating this knowledge to provide a better estimate of cross media reach.</p>
<p>For example in the UK, to measure joint media reach at a local level, we may still be able to use the currencies for each media as long as they provide sufficient data points in each local area. To join them, we can use information from a separate cross media data source that measures the same media but at a higher relevant geographical level. Whilst not perfect, this gives us a much more realistic cross media dependence structure than the hypothesis of independence.</p>
<p>This approach is currently used to estimate the BBC’s cross media reach for local content in each local area, as defined by the local radio stations measurement footprint.</p>
</section>
</section>
<section id="conclusion-2" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> conclusion</h1>
<p>In this article we show a practical way of modelling a multivariate distribution ensuring that the joint zeros (combined reach) and the volumes (total number of items or time spent) are preserved, as is the common objective when modelling univariate reach and frequency in media measurement. The use of the Tetrachoric correlation ensures that we can incorporate any knowledge we may have about the joint zeros. This approach can be used to model multi-media usage while preserving the currencies. It could be further developed to incorporate other important planning variables such as demographics and used as an alternative or complement to data fusion.</p>
</section>
<section id="references" class="level1 numbered" data-number="5">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">5 References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-synthpop" class="csl-entry" role="listitem">
Dibben, Beata Nowok, Gillian M. Raab, Chris. 2016. <span>“Synthpop: Bespoke Creation of Synthetic Data in r.”</span> <em>Journal of Statistical Software</em>. <a href="https://doi.org/10.18637/jss.v074.i11">https://doi.org/10.18637/jss.v074.i11</a>.
</div>
<div id="ref-ehrenberg" class="csl-entry" role="listitem">
Ehrenberg, A. S. C. 1959. <span>“The Pattern of Consumer Purchases.”</span> <em>Applied Statistics</em>. <a href="https://doi.org/10.2307/2985810">https://doi.org/10.2307/2985810</a>.
</div>
<div id="ref-tetrachoric" class="csl-entry" role="listitem">
<span>“Estimating Correlation from Dichotomized Normal Variables.”</span> 2009. <em>Journal of Statistical Planning and Inference</em> 139 (11): 3785–94. https://doi.org/<a href="https://doi.org/10.1016/j.jspi.2009.05.031">https://doi.org/10.1016/j.jspi.2009.05.031</a>.
</div>
<div id="ref-greenens2020" class="csl-entry" role="listitem">
Greenens, Gery. 2020. <span>“Copula Modeling for Discrete Random Vectors.”</span> <em>De Gruyter</em>. <a href="https://doi.org/10.1515/demo-2020-0022">https://doi.org/10.1515/demo-2020-0022</a>.
</div>
<div id="ref-genest" class="csl-entry" role="listitem">
Nešlehová, Christian Genest, Johanna. 2007. <span>“A Primer on Copulas for Count Data.”</span> <em>ASTIN Bulletin</em>. <a href="https://doi.org/10.2143/AST.37.2.2024077">https://doi.org/10.2143/AST.37.2.2024077</a>.
</div>
<div id="ref-sharot" class="csl-entry" role="listitem">
Sharot, Trevor. 2011. <span>“Data Fusion - a White Paper by Ipsos MediaCT.”</span> <a href="https://www.ipsos.com/sites/default/files/publication/1970-01/IpsosMediaCT_WhitePaper_DataFusion_Jun2011.pdf">https://www.ipsos.com/sites/default/files/publication/1970-01/IpsosMediaCT_WhitePaper_DataFusion_Jun2011.pdf</a>.
</div>
<div id="ref-poisson_multivariate" class="csl-entry" role="listitem">
Shmueli, Inbal Yahav, Galit. 2008. <span>“An Elegant Method for Generating Multivariate Poisson Random Variables.”</span> <em>arXiv</em>. <a href="https://doi.org/10.48550/arXiv.0710.5670">https://doi.org/10.48550/arXiv.0710.5670</a>.
</div>
<div id="ref-sklar" class="csl-entry" role="listitem">
Sklar, S. W. 1959. <span>“Fonctions de Répartition à n Dimension Et Leurs Marges.”</span> <em>Publications de l’Institut de Statistique de l’Université de Paris</em>, 229–31. <a href="https://doi.org/10.2139/ssrn.4198458">https://doi.org/10.2139/ssrn.4198458</a>.
</div>
<div id="ref-copula_package" class="csl-entry" role="listitem">
Yan, Jun. 2007. <span>“Enjoy the Joy of Copulas: With a Package Copula.”</span> <em>Journal of Statistical Software</em>. <a href="https://doi.org/10.18637/jss.v021.i04">https://doi.org/10.18637/jss.v021.i04</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>